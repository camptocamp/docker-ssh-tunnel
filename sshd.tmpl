Port {{ getenv "SSH_PORT" }}
Protocol 2

AllowTcpForwarding yes
PermitOpen localhost:1
{{- range $stack := lsdir "/stacks" }}
  {{- range $service := lsdir (printf "/stacks/%s/services" $stack) }}
    {{- range $label := ls (printf "/stacks/%s/services/%s/labels" $stack $service) }}
      {{- if eq . "ssh_tunnel.port" }}
        {{- $port := getv (printf "/stacks/%s/services/%s/labels/%s" $stack $service $label) }}
        {{- printf " %s.%s:%s" $service $stack $port }}  
        {{- range lsdir (printf "/stacks/%s/services/%s/containers" $stack $service) }}
          {{- printf " %s:%s" . $port }}
        {{- end }}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end }}
